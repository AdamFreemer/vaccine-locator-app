<div class="shadow-sm p-3 mb-6 bg-white rounded">
  <p class="text-center">Welcome to VaxxMax. This is the Rite Aid vaccine slot finder page.
    You'll want to go here first: <a href="https://www.riteaid.com/pharmacy/apt-scheduler" target="_blank">https://www.riteaid.com/pharmacy/apt-scheduler</a>.<br>
    After required pre-qualification, find an available location below to copy / paste to on the Rite Aid website for scheduling.<br>
     <a href="rite-aid-instructions.pdf" target="_blank">Detailed instructions can be found by clicking here.</a>
  </p>


  <p class="text-center">
    The below locations have been recently updated and have the best probability of a slot being open based on the "Last Updated" date field.
  </p>
  
  <div class="table-responsive">
    <table class="table table-striped table-bordered table-condensed" id="locations">
      <thead class="thead-dark">
        <tr>
          <th class="text-center">ID (Website)</th>
          <th class="text-center">Open Slots</th>      
          <th>Clickable Address (Google Maps)</th>
          <th>City</th>
          <th>State</th>
          <th>Zip</th>
          <th>Last Updated</th>
          <th>Became Available</th>
          <th class="text-left">Distance (mi)</th>
        </tr>
      </thead>

      <tbody>
        <% @locations.each do |location| %>
          <tr data-lat="<%= location.latitude %>" data-lon="<%= location.longitude %>">
            <td class="text-center"><%= link_to location.store_number, location&.rite_aid_location_website, target: :_blank %></td>
            <td class="text-center">
              <% if location.slot_1 %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill text-green" viewBox="0 0 16 16">
                  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                </svg>   
              <% else %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                </svg>           
              <% end %>
            </td>

            <td>
              <%= link_to location.full_address, location.google_search, id: "full-address-#{location.id}", target: :_blank %>
              <button class="btn btn-xs btn-outline-primary" data-clipboard-target="#full-address-<%= location.id %>">
                Copy
              </button>              
            </td>
            <td><%= location.city %></td>
            <td class="text-center"><%= location.state %></td>
            <td class="text-center"><%= location.zip %></td>
            <td>
              <%= content_tag(:span, location.last_updated&.strftime('%m-%e-%Y, %H:%M:%S'), style: 'display:none') %>
              <%= time_ago_in_words(location.last_updated) %> ago
            </td>
            <td>
              <%= content_tag(:span, location.when_available&.strftime('%m-%e-%Y, %H:%M:%S'), style: 'display:none') %>
              <%= time_ago_in_words(location.when_available) %> ago
            </td>
            <td class="text-center">
            <%= puts session[:zipcode] %>
              <%= location.distance(@user_ip, session[:zipcode] ||= "", location).to_i %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>


<% if @locations_old.length > 0 %>
<div class="shadow-sm p-3 mb-5 bg-white rounded">
  <p class="text-center">The below locations are stale and most likely do not have availability.</p>
  <div class="table-responsive">
    <table class="table table-striped table-bordered table-condensed" id="locations">
      <thead class="thead-dark">
        <tr>
          <th class="text-center">ID (Website)</th>
          <th class="text-center">Open Slots</th>      
          <th>Clickable Address (Google Maps)</th>
          <th>City</th>
          <th>State</th>
          <th>Zip</th>
          <th>Last Updated</th>
          <th>Became Available</th>
        </tr>
      </thead>

      <tbody>
        <% @locations_old.each do |location| %>
          <tr>
            <td class="text-center"><%= link_to location.store_number, location&.rite_aid_location_website, target: :_blank %></td>
            <td class="text-center">
              <% if location.slot_1 %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill text-green" viewBox="0 0 16 16">
                  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                </svg>   
              <% else %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                </svg>           
              <% end %>
            </td>

            <td>
              <%= link_to location.full_address, location.google_search, id: "full-address-#{location.id}", target: :_blank %>
              <button class="btn btn-xs btn-outline-primary" data-clipboard-target="#full-address-<%= location.id %>">
                Copy
              </button>              
            </td>
            <td><%= location.city %></td>
            <td class="text-center"><%= location.state %></td>
            <td class="text-center"><%= location.zip %></td>
            <td>
              <%= content_tag(:span, location.last_updated&.strftime('%m-%e-%Y, %H:%M:%S'), style: 'display:none') %>
              <%= time_ago_in_words(location.last_updated) %> ago
            </td>
            <td>
              <%= content_tag(:span, location.when_available&.strftime('%m-%e-%Y, %H:%M:%S'), style: 'display:none') %>
              <%= time_ago_in_words(location.when_available) %> ago
            </td>          
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
<% end %>

<div id="provider_status" value="riteaid" style="visibility: hidden"></div>
<div id="zipcode_status" value="riteaid" style="visibility: hidden"></div>

<script>
  $('#locations').DataTable(
    {
      "dom": '<"toolbar">frtip',
      "iDisplayLength": 25,
      "order": [[ 7, "desc" ]],
      "oLanguage": {
        "sSearch": "Search: "
      }
    }
  );

  $(document).ready(function() {
    // datatables add zip field
    $("#provider").on('change', function(){
      console.log("provider onchange riteaid: " + $("#provider").val())
      if ($("#provider").val() == "health_mart") {
        localStorage['provider'] = "health_mart";
        document.location.href = '/health_mart';
      }
      
      if ($("#provider").val() == "walgreens") {
        localStorage['provider'] = "walgreens";
        document.location.href = '/walgreens';
      }
      if ($("#provider").val() == "riteaid") {
        localStorage['provider'] = "riteaid";
        document.location.href = '/riteaid';
      }
      if ($("#provider").val() == "cvs") {
        localStorage['provider'] = "cvs";
        document.location.href = '/cvs';
      }
    });


    $("div.toolbar").html(
      '<div class="d-inline-flex justify-content-center zip-container"><input type="zipcode" maxlength="5" class="col-6 form-control zipcode" id="zipcode" aria-describedby="zipcode"><button type="button" id="set-zipcode">Set Zip Code</button></div><br>'
      );

    page = document.getElementById('provider_status').getAttribute('value')
    console.log('-- page: ' + page)
    if ( localStorage['provider'] == null ) {
      localStorage['provider'] = "riteaid";
      document.location.href = '/riteaid';
    }
    $("#provider").val(page)

    $("#set-zipcode").on('click', function(){
      var zipcode = $("#zipcode").val();
      var numbers = /^[0-9]+$/;

      if (!zipcode.match(numbers)) {
        alert("Zipcode must be numerical and 5 digits.")
      } 

      if (zipcode != "" && zipcode.match(numbers)) {
        localStorage['zipcode'] = zipcode
        $.get( "/set_zipcode/" + zipcode, function( data ) {
          $( ".result" ).html( data );
          location.reload();
        });
      }
    });

    if (localStorage['zipcode'] == null || localStorage['provider'] == null) {
      $("#zipcode").attr("placeholder", "Enter Zipcode");
    } else {
      $("#zipcode").attr("value", localStorage['zipcode']);
    }
  });
</script>

<style>
  @media only screen and (min-width:769px) {
    .zip-container {
      margin-left: -34px;
    }
  }

  .zip-container {
    margin-bottom: 10px !important;
  }

  .zipcode {
    margin-right: 5px;
    height: 30px;
  }

  .toolbar {
      float: left;
  }
</style>