<div class="shadow-sm p-3 mb-6 bg-white rounded">
  <header>
    <%= render "layouts/header" %>
    <div class="row dropdowns">
      <%= render "layouts/provider" %>
      <div class="col-sm text-center">
        <code class="text-black">Facebook: <a href="https://www.facebook.com/vaxxmax" target="_blank">https://www.facebook.com/vaxxmax</a></code><br>
        <button class="btn btn-xs btn-outline-primary changelog" id="changelog" data-toggle="modal" data-target="#changelogModal">
          <code class="text-dark">What's New!</code>
        </button>
      </div>
      <div class="col-sm">
        <%= select_tag "state-select-cvs", options_for_select(@states, session[:state_cvs]), prompt: 'Select State', class: "form-control" %>
      </div>
    </div>
  </header>
</div>

<div class="shadow-sm p-3 mb-6 bg-white rounded">
  <p class="text-center">Welcome to VaxxMax. This is the CVS vaccine slot finder page.<br>
  You'll want to go here first and sign-up for an account if you haven't already: <a href="https://www.cvs.com/vaccine/intake/store/covid-screener/covid-qns" target="_blank">https://www.cvs.com/vaccine/intake/store/covid-screener/covid-qns</a>.<br>
    After required pre-qualification, refer back to the VaxxMax site for availabilities, from where you can copy / paste the location zip code of your choice.<br>
  </p>

  <p class="text-center">
    This page auto-refreshes every 60 seconds.
  </p>
  
  <div class="table-responsive">
    <table class="table table-striped table-bordered table-condensed" id="locations">
      <thead class="thead-dark">
        <tr>
          <th>Availability</th>
          <th>Town / City</th>
          <th class="text-center">State</th>      
          <th class="text-center">Zip</th>
          <th class="text-center">County</th>
          <th>Last Updated</th>
          <th>Became Available</th>
          <th class="text-center">Distance (mi)</th>           
        </tr>
      </thead>

      <tbody>
        <% @locations.each do |location| %>
          <tr>
            <td class="text-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill text-green" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
              </svg>   
            </td>
            <td><%= location.name %></td>
            <td class="text-center"><%= location.state %></td>
            <td class="text-center">
              <span id="zip-<%= location.id %>"><%= location.zip %></span>
              <button class="btn btn-xs btn-outline-primary" data-clipboard-target="#zip-<%= location.id %>">
                Copy
              </button> 
            </td>
            <td><%= location.county %></td>
            <td>
              <%= content_tag(:span, location.last_updated&.strftime('%m-%e-%Y, %H:%M:%S'), style: 'display:none') %>
              <%= time_ago_in_words(location.last_updated) %> ago
            </td>
            <td>
              <%= content_tag(:span, location.when_available&.strftime('%m-%e-%Y, %H:%M:%S'), style: 'display:none') %>
              <%= time_ago_in_words(location.when_available) %> ago
            </td>
            <td class="text-center">
              <%= location.distance(@user_ip, @zipcode, location).to_i %> 
            </td>             
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<%# Set Provider dropdown to page value %>
<div id="provider-status" value="cvs" style="visibility: hidden"></div>

<script>
  $('#locations').DataTable(
    {
      "iDisplayLength": 25,
      "order": [[ 5, "desc" ]],
      "oLanguage": {
        "sSearch": "Search: ",
        "sEmptyTable": "No vaccination appointments are currently listed as available from CVS for this state."
      }
    }
  );

  $(document).ready(function() {
    $("#state-select-cvs").on('change', function(){
      var state_dropdown_value = $("#state-select-cvs").val();

      $.get( "/set_state_cvs/" + state_dropdown_value, function( data ) {
        $( ".result" ).html( data );
        location.reload();
      });
    });    
  });
</script>

<%= render "layouts/provider_js" %>
